---
title: "Proyecto Valparaíso: 35 ebuses"
author: "Estudios"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    theme: simplex
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(htmltools)
library(knitr)
library(kableExtra)
library(DiagrammeR)
library(tibble)
library(ggplot2)
library(GGally)
library(leaflet)
library(tmap)
library(tmaptools)
```

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri(file.path("../data/img/logoTransdev.png")
                                      ),
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:1px;')
```

## INTRODUCCIÓN

En este documento se analizará la movilidad de Valparaiso y la aplicación de las nuevas rutas eléctricas.
Es un electrocorredor con 2 nuevos servicios, recorrerán entre Placilla y Plaza Wheelwrigth), diferenciándose en sus trazados en Placilla. Como referencia inicial tenemos el recorrido 901, 902, 903 y 800x(trolebus).

Referencialmente, la característica de los servicios es la siguiente:

- Recaudación

````{r, echo = F}
rts_new <- tibble(Variable = c("Demanda Potencial", 
                    "Flota",
                    "Tarifa", 
                    "Recaudación Anual Estimada", 
                    "Total Km Comerciales Anuales"), 
       Valor = c(13187, 35, 500, 1556546267, 2371792), 
       Unidad = c("pax/dln", "Bus","$/adulto", "$", "distancia"))
kable(rts_new, format.args = list(big.mark = ",")) %>%
  kable_paper("striped", full_width = F) %>%
  column_spec(1:2, bold = T, color = "white", background = "#D7261E")
````

- Frecuencia

````{r, echo = F}
Frec <- tibble(Servicio = rep(c("E01", "E02"), each = 48),
       Sentido = rep(c("Ida", "Regreso"), each = 24, times = 2),
       Longitud = rep(c(23, 23.7, 24.1, 23.6), each = 24),
       Frecuencia = c(rep(0, 5), 2, 5, 6, 6, 5, 4, 4, 4, 5, 4, 4, 4, 5, 6, 6, 4, 2, 0, 0, rep(0, 6), 1, 6, 6, rep(4, 5), 5, 4, 4, rep(6, 4), 4, 1, 0, rep(0, 6), 2, 6, 5, rep(4, 4), 5, rep(4, 3), 5, 5, 4, 3, 1, 0, 0, rep(0, 7), 2, 5, 5, rep(4, 4), 5, 4, 4, 5, 6, 5, 4, 3, 0, 0),
       Hora = rep(seq(from = 0, to=23), 4))

ggplot(Frec, aes(x=Hora, y=Frecuencia)) +
  geom_line(color = "#D7261E", size = 1) +
  facet_wrap(vars(Servicio, Sentido)) +
  theme_bw()
````

La topología de los recorridos es la siguiente:

````{r, message = F, warning = F, echo = F, fig.align = 'center', out.width = '100%'}
map <- tm_basemap(leaflet::providers$Esri.WorldImagery) +
  tm_basemap(leaflet::providers$OpenStreetMap) +
  tm_shape(elec_rt) + 
  tm_lines("Rutas", 
           lwd = 2, 
           palette = "Dark2", 
           popup.vars = c("Rutas", "Dist")) +
  tm_shape(rts_geo.h[[1]], name = "metro") +
  tm_symbols(col = "#D7261E", size = .1) +
  tm_shape(rts_geo.h[[2]], name = "UN1") +
  tm_lines(col = "black") +
  tm_shape(rts_geo.h[[3]], name = "UN2") +
  tm_lines(col = "black") +
  tm_shape(rts_geo.h[[4]], name = "UN3") +
  tm_lines(col = "black") +
  tm_shape(rts_geo.h[[5]], name = "UN4") +
  tm_lines(col = "black") +
  tm_shape(rts_geo.h[[6]], name = "UN5") +
  tm_lines(col = "black") +
  tm_shape(rts_geo.h[[7]], name = "UN6") +
  tm_lines(col = "black") +
  tm_shape(rts_geo.h[[8]], name = "UN7") +
  tm_lines(col = "black") +
  tm_shape(rts_geo.h[[9]], name = "UN8") +
  tm_lines(col = "black") +
  tm_shape(rts_geo.h[[10]], name = "UN9") +
  tm_lines(col = "black")

tmap_leaflet(map)
````

La elevación del Terreno en los puntos que pasan los recorridos es la siguiente:

````{r, echo = F, warning = F}
ggplot(elec_rst, aes(Orden, elevation)) +
  geom_line() +
  labs(title = "Elevaciones", y = "Elevación") +
  facet_wrap(~Rutas, nrow = 3)

ggplot(elec_rst, aes(Orden, `% elev`)) +
  geom_line() +
  labs(title = "Pendiente", y = "%") +
  facet_wrap(~Rutas, nrow = 3)
````

Para entender el efecto de la Temperatura se grafica las temperaturas extremas, tanto de la *<span style="color: #FF0000;">línea base</span>* (1980-2010) como el *<span style="color: #FF0000;">Escenario</span>* (2050):

````{r, echo = F, warning = F}
ggplot(temp, aes(Sector_class, Temp, fill = T_class)) +
  geom_bar(stat = "identity") +
  facet_wrap(~factor(tipo, levels = c("Linea Base", "2050")
                     )
             ) +
  xlab("Temperatura por Zona") +
  labs(fill = "Tipo de Temperatura",
       caption = "TNJ: Temperatura mínima invernal\nTXE: Temperatura máxima estival") +
  theme(axis.text=element_text(size=8)) +
  scale_x_discrete(labels = c("Lit.", "Sec. Int.", "Lit.", "Sec. Int."))  
````

Respecto al desarrollo operacional , el acopio en los cabezales es el siguiente:

````{r, echo = F, warning = F}
ggplot(acopios_Cab, aes(x=minuto, y=value)) +
  geom_line() +
  facet_wrap(~factor(posición, 
                     levels = c("Plaza Wheelwright_LaboralN",
                                "Plaza Wheelwright_SábadoN",
                                "Plaza Wheelwright_DomingoN", 
                                "Curauma_LaboralN",
                                "Curauma_SábadoN",
                                "Curauma_DomingoN")
                     )
             ) 
````

Para los buses en circulación:

````{r, echo = F, warning = F}
ggplot(acopios_Circ, aes(x=minuto, y=value)) +
  geom_line() +
  facet_wrap(~factor(posición, 
                     levels = c("BusesConducción_LaboralN",
                                "BusesConducción_SábadoN",
                                "BusesConducción_DomingoN")
                     )
             )
````

Los buses en depósito con propósito de carga:

````{r, echo = F, warning = F}
ggplot(acopios_Dep, aes(x=minuto, y=value)) +
  geom_line() +
  facet_wrap(~factor(posición, 
                     levels = c("DepósitoCargando_LaboralN",
                                "DepósitoCargando_SábadoN", 
                                "DepósitoCargando_DomingoN")
                     )
             )

````

Las velocidades de los nuevos recorridos son:

````{r, echo = F, warning = F}
ggplot(vel, aes(hora, Velocidad)) +
  geom_bar(stat = "identity") +
  facet_wrap(~SS + factor(Tipo_día,
                          levels = c("Laboral", "Sábado", "Domingo")),
             nrow = 4) +
  scale_x_continuous(breaks = seq(5,24, by = 2))
````

La relación entre las variables procesadas para los buses a nivel de sentido es la siguiente:

- Punta Mañana 1:

````{r, echo = F, warning = F, message = F, out.width = '100%'}
ggpairs(nt_dt[nt_dt$per == "am1" & nt_dt$modo1 %in% c("bus","busmer"), c(4:9, 11)], aes(color = modo1)) +
theme_grey(base_size = 4)
````

- Punta Mañana 2:

````{r, echo = F, warning = F, message = F, out.width = '100%'}
ggpairs(nt_dt[nt_dt$per == "am2" & nt_dt$modo1 %in% c("bus","busmer"), c(4:9, 11)], aes(color = modo1)) +
theme_grey(base_size = 4)
````

- Fuera de Punta:

````{r, echo = F, warning = F, message = F, out.width = '100%'}
ggpairs(nt_dt[nt_dt$per == "fp" & nt_dt$modo1 %in% c("bus","busmer"), c(4:9, 11)], aes(color = modo1)) +
theme_grey(base_size = 4)
````

- Punta Tarde:

````{r, echo = F, warning = F, message = F, out.width = '100%'}
ggpairs(nt_dt[nt_dt$per == "pt1" & nt_dt$modo1 %in% c("bus","busmer"), c(4:9, 11)], aes(color = modo1)) +
theme_grey(base_size = 4)
````

En cambio si queremos ver la relación con la variable flota, lo hacemos a nivel de linea:

- Punta Mañana 1:

````{r, echo = F, warning = F, message = F, out.width = '100%'}
ggpairs(lines_dt[lines_dt$per == "am1" & lines_dt$modo1 %in% c("bus","busmer"), c(3:9)], aes(color = modo1)) +
  theme_grey(base_size = 4)
````

- Punta Mañana 2:

````{r, echo = F, warning = F, message = F, out.width = '100%'}
ggpairs(lines_dt[lines_dt$per == "am2" & lines_dt$modo1 %in% c("bus","busmer"), c(3:9)], aes(color = modo1)) +
  theme_grey(base_size = 4)

````

- Fuera de Punta:

````{r, echo = F, warning = F, message = F, out.width = '100%'}
ggpairs(lines_dt[lines_dt$per == "fp" & lines_dt$modo1 %in% c("bus","busmer"), c(3:9)], aes(color = modo1)) +
  theme_grey(base_size = 4)

````

- Punta Tarde:

````{r, echo = F, warning = F, message = F, out.width = '100%'}
ggpairs(lines_dt[lines_dt$per == "pt1" & lines_dt$modo1 %in% c("bus","busmer"), c(3:9)], aes(color = modo1)) +
  theme_grey(base_size = 4)
````

## PROCEDIMIENTO

De las fuentes de datos disponibles, esto es del estudio *CIS* para día laboral y los parámetros de la red de modelación sectra, esto es, para los periodos: *am1, am2, fp, pt1*. 

El modelo ha sido estrcuturado según las siguientes variables: 

- Periodo
- Servicio
- Tipo de Usuario
- Clasificación de Tarifa
- Tiempo de Recorrido
- Distancia de Recorrido
- Frecuencias

Las categorías de Usuario son las siguientes:

Las clasificación de Tarifa es la siguiente:

## RESULTADOS

````{r, echo = F}

kable(rts_new, format.args = list(big.mark = ",")) %>%
  kable_paper("striped", full_width = F) %>%
  column_spec(1:2, bold = T, color = "white", background = "#D7261E")
````
